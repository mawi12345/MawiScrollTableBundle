(function(){var t,e,i,s,n={}.hasOwnProperty,o=function(t,e){function i(){this.constructor=t}for(var s in e)n.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},a=function(t,e){return function(){return t.apply(e,arguments)}};t=jQuery,e=function(){function t(t,e){this.name=t,this.loading=e}return t.prototype.setup=function(t,e){return e()},t.prototype.info=function(t,e,i){return this.loading(!0),this.loading(!1),i({rows:0,pagesize:20})},t.prototype.page=function(t,e,i,s,n){return this.loading(!0),this.loading(!1),n("")},t}(),s=function(e){function i(t,e){this.name=t,this.loading=e}return o(i,e),i.prototype.info=function(e,i,s){var n,o=this;return this.loading(!0),n=Routing.generate("scrolltable_info",{name:this.name}),t.ajax({url:n,type:"GET",dataType:"xml",success:function(e){return o.loading(!1),s({pages:1*t(e).find("pc").text()})},error:function(){return o.loading(!1),i()}})},i.prototype.page=function(e,i,s,n,o){var a,r=this;return this.loading(!0),0>=i.length&&(i="default"),a=Routing.generate("scrolltable_page",{name:this.name,number:s,order:i,filter:e}),t.ajax({url:a,type:"GET",dataType:"html",success:function(e){var i;return i=t(e),r.loading(!1),o(i)},error:function(){return r.loading(!1),n()}})},i}(e),i=function(){function e(e){var i,n=this;this.options=e,this.trigger=a(this.trigger,this),this.delPage=a(this.delPage,this),this.cleanup=a(this.cleanup,this),this.addPage=a(this.addPage,this),this.loadPages=a(this.loadPages,this),this.scroll=a(this.scroll,this),this.refresh=a(this.refresh,this),this.page=a(this.page,this),this.info=a(this.info,this),this.connectorLoadingStateChange=a(this.connectorLoadingStateChange,this),this.errorHandler=a(this.errorHandler,this),this.log=a(this.log,this),this.resetState=a(this.resetState,this),i={debug:!1,selector:{page:".st-page",space:".st-space"},distance:5,clean:8,order:"",filter:""},this.settings=t.extend(i,e),this.el=this.settings.el,this.initState={pages:0,pageHeight:0,last:-1e4,pages:[],viewStartPage:0,viewEndPage:0,needCleanup:!1,needFill:!1,needScroll:!1},this.state={},this.resetState(),this.connectorLoading=!1,this.connections=0,this.name=this.el.attr("data-scrolltable"),this.connector=new s(this.name,this.connectorLoadingStateChange),this.log("page height: "+this.state.pageHeight),this.connector.setup(this.errorHandler,function(){return n.log("connector finished setup"),n.resize(function(){return n.fill(),t(window).on("scroll",n.scroll),n.scroll()})})}return e.prototype.resetState=function(){var t;for(t in this.initState)this.state[t]=this.initState[t];return this.state.pageHeight=this.el.find(this.settings.selector.page).first().outerHeight()},e.prototype.log=function(t){return this.settings.debug?"undefined"!=typeof console&&null!==console?console.log(t):void 0:void 0},e.prototype.errorHandler=function(){return this.log("ERROR")},e.prototype.connectorLoadingStateChange=function(t){if(t?this.connections++:this.connections--,0>=this.connections&&this.connectorLoading){if(this.log("connector has finished loading"),this.trigger("loading",!1),this.connectorLoading=!1,this.state.needCleanup&&(this.state.needCleanup=!1,this.cleanup()),this.state.needFill&&(this.state.needFill=!1,this.fill()),this.state.needScroll)return this.state.needScroll=!1,this.scroll()}else if(this.connections>0&&!this.connectorLoading)return this.log("connector is loading"),this.trigger("loading",!0),this.connectorLoading=!0},e.prototype.info=function(t){return this.connector.info(this.settings.filter,this.errorHandler,t)},e.prototype.page=function(t,e){return this.connector.page(this.settings.filter,this.settings.order,t,this.errorHandler,e)},e.prototype.resize=function(t){var e=this;return this.info(function(i){return e.log(i),e.state.pages=i.pages,e.el.height(i.pages*e.state.pageHeight+"px"),e.log(e.state),t()})},e.prototype.refresh=function(){var t=this;return this.resetState(),this.resize(function(){return t.el.find(t.settings.selector.page).remove(),t.el.find(t.settings.selector.space).remove().first().appendTo(t.el),t.fill(),t.scroll()})},e.prototype.fill=function(){var e,i,s,n,o,a,r,h,l,g,p,c;for(o=this.el.find(this.settings.selector.page),r=this.el.find(this.settings.selector.space).detach().first(),this.state.positions=[],h=0,g=o.length;g>h;h++){for(n=o[h],a=1*t(n).attr("data-p"),i=-1,c=this.state.positions,l=0,p=c.length;p>l;l++)s=c[l],a>s&&(i=s);this.state.positions.push(a),0>i&&a>0&&t(n).before(r.clone().height(a*this.state.pageHeight+"px")),i>0&&a>i+1&&t(n).before(r.clone().height((a-i-1)*this.state.pageHeight+"px"))}return e=this.state.positions.length>0?this.state.pages-this.state.positions[this.state.positions.length-1]-1:this.state.pages,e>0?this.el.append(r.clone().height(e*this.state.pages+"px")):void 0},e.prototype.pixelToPage=function(t){return Math.floor(t/this.state.pageHeight)},e.prototype.scroll=function(){var e,i,s,n;return this.connectorLoading===!0?(this.state.needScroll=!0,!1):(n=t(document).scrollTop()-this.el.position().top,s=window.innerHeight,this.state.viewStartPage=this.pixelToPage(n),this.state.viewEndPage=this.pixelToPage(n+s),0>this.state.viewStartPage&&(this.state.viewStartPage=0),this.state.viewEndPage>=this.settings.pages&&(this.state.viewEndPage=this.state.pages-1),Math.abs(this.state.last-n)<this.settings.distance*this.state.pageHeight?!1:(this.state.last=n,i=this.state.viewStartPage-this.settings.distance,e=this.state.viewEndPage+this.settings.distance,0>i&&(i=0),e>=this.state.pages&&(e=this.state.pages-1),this.loadPages(i,e),!0))},e.prototype.loadPages=function(e,i){var s,n,o,a,r,h,l,g=this;if(this.log("load pages: "+e+" - "+i),o=function(){h=[];for(var t=e;i>=e?i>=t:t>=i;i>=e?t++:t--)h.push(t);return h}.apply(this),s=t.grep(o,function(e){return 0>t.inArray(e,g.state.positions)?1:0}),1>s.length)return!1;for(this.state.needCleanup=!0,l=[],a=0,r=s.length;r>a;a++)n=s[a],l.push(this.page(n,function(t){return g.addPage(t),g.fill()}));return l},e.prototype.addPage=function(e){var i,s,n,o,a,r,h,l,g;if(r=1*t(e).attr("data-p"),0===this.state.positions.length)return this.el.append(e),this.state.positions.push(r),!0;for(n=o=this.state.pages,g=this.state.positions,s=h=0,l=g.length;l>h&&(a=g[s],!(a!==r&&(i=Math.abs(a-r),n>i&&(n=i,o=a),1>=i||a>r)));s=++h);return this.delPage(r),r>o?(t(e).insertAfter('[data-p="'+o+'"]'),this.state.positions.splice(o,0,r)):(t(e).insertBefore('[data-p="'+o+'"]'),this.state.positions.splice(o-1,0,r))},e.prototype.cleanup=function(){var t,e,i,s,n,o,a;for(e=this.state.viewStartPage-this.settings.clean,t=this.state.viewEndPage+this.settings.clean,0>e&&(e=0),t>=this.settings.pages&&(t=this.state.pages-1),o=this.state.positions,a=[],s=0,n=o.length;n>s;s++)i=o[s],e>0&&e>i&&this.delPage(i),this.state.pages>t?i>t?a.push(this.delPage(i)):a.push(void 0):a.push(void 0);return a},e.prototype.delPage=function(e){return t('[data-p="'+e+'"]').remove()},e.prototype.trigger=function(t,e){return this.settings.el.trigger(t,e)},e}(),t(function(){return t.fn.extend({scrollTable:function(e){return t(this).each(function(){return t(this).data("ScrollTable",new i(t.extend({el:t(this)},e)))})}}),t("[data-scrolltable]").scrollTable()})}).call(this);